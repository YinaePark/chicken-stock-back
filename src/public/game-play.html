<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹˜í‚¨ìŠ¤í†¡ê²Œì„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .user-header {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-email {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 0.8em;
            color: #6c757d;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 20px;
            color: #155724;
            font-size: 0.9em;
        }

        .auth-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .game-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .game-header h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .info-card strong {
            display: block;
            margin-bottom: 5px;
            color: #495057;
        }

        .game-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-playing { background: #28a745; color: white; }
        .status-waiting { background: #ffc107; color: #212529; }
        .status-finished { background: #dc3545; color: white; }

        .round-timer {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .timer-warning { background: #fff3cd !important; color: #856404 !important; }
        .timer-danger { background: #f8d7da !important; color: #721c24 !important; }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr 250px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .my-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .stat-value {
            font-weight: bold;
        }

        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        .portfolio-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .portfolio-stock {
            font-weight: bold;
            color: #2c3e50;
        }

        .portfolio-quantity {
            font-size: 0.9em;
            color: #6c757d;
        }

        .main-panel {
            min-height: 600px;
        }

        .stock-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stock-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            min-width: 120px;
        }

        .stock-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .stock-tab.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .price-display {
            margin-bottom: 15px;
        }

        .current-price {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .price-change {
            font-size: 1.1em;
            font-weight: 500;
        }

        .trading-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .trade-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: #495057;
        }

        .form-group select,
        .form-group input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-buy {
            background: #28a745;
            color: white;
        }

        .btn-buy:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-sell {
            background: #dc3545;
            color: white;
        }

        .btn-sell:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .players-panel {
            max-height: 600px;
            overflow-y: auto;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #6c757d;
        }

        .player-card.current-user {
            border-left-color: #3498db;
            background: #e3f2fd;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .player-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .bottom-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .trade-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .trade-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .trade-buy {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .trade-sell {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
        }

        .chat-sender {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 2px;
        }

        .chat-text {
            color: #495057;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 1200px) {
            .game-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .bottom-panels {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .stock-selector {
                flex-direction: column;
            }
            
            .stock-tab {
                min-width: auto;
            }

            .user-header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ì‚¬ìš©ì ì •ë³´ í—¤ë” -->
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-email" id="userEmail">ë¡œë”© ì¤‘...</div>
                    <div class="user-id" id="userId">ì‚¬ìš©ì ID: -</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="auth-status" id="authStatus">
                    <span>ğŸ” ì¸ì¦ë¨</span>
                </div>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ê²Œì„ í—¤ë” -->
        <div class="game-header">
            <h1 id="gameTitle">ğŸ” ì¹˜í‚¨ìŠ¤í†¡ê²Œì„</h1>
            <div class="game-info">
                <div class="info-card">
                    <strong>ê²Œì„ ìƒíƒœ</strong>
                    <span id="gameStatus" class="game-status status-playing">PLAYING</span>
                </div>
                <div class="info-card">
                    <strong>í˜„ì¬ ë¼ìš´ë“œ</strong>
                    <span id="currentRound">1/10</span>
                </div>
                <div class="info-card">
                    <strong>ì°¸ê°€ì</strong>
                    <span id="playerCount">4/4ëª…</span>
                </div>
                <div class="info-card">
                    <strong>ë‚´ ìˆœìœ„</strong>
                    <span id="myRanking">-ìœ„</span>
                </div>
            </div>
            
            <!-- ë¼ìš´ë“œ íƒ€ì´ë¨¸ -->
            <div id="roundTimer" class="round-timer">
                ë‚¨ì€ ì‹œê°„: <span id="timeRemaining">05:00</span>
            </div>
        </div>
        
        <!-- ë©”ì¸ ê²Œì„ ë ˆì´ì•„ì›ƒ -->
        <div class="game-layout">
            <!-- ì™¼ìª½: ë‚´ ì •ë³´ íŒ¨ë„ -->
            <div class="panel my-info">
                <h3>ğŸ’° ë‚´ ì •ë³´</h3>
                <div class="my-stats">
                    <div class="stat-item">
                        <span class="stat-label">í˜„ê¸ˆ</span>
                        <span class="stat-value" id="myCash">1,000,000ì›</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì´ ìì‚°</span>
                        <span class="stat-value" id="myTotalAsset">1,000,000ì›</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì†ìµ</span>
                        <span class="stat-value positive" id="myProfitLoss">+0ì›</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìˆ˜ìµë¥ </span>
                        <span class="stat-value positive" id="myProfitRate">+0.00%</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">ğŸ“Š ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>
                <div id="myPortfolio" class="portfolio-grid">
                    <div class="loading">í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ì¤‘ì•™: ì£¼ì‹ ì°¨íŠ¸ ë° ê±°ë˜ íŒ¨ë„ -->
            <div class="panel main-panel">
                <h3>ğŸ“ˆ ì£¼ì‹ ê±°ë˜</h3>
                
                <!-- ì¢…ëª© ì„ íƒ íƒ­ -->
                <div id="stockTabs" class="stock-selector">
                    <div class="loading">ì£¼ì‹ ì •ë³´ ë¡œë”© ì¤‘...</div>
                </div>
                
                <!-- ì°¨íŠ¸ ì˜ì—­ -->
                <div class="chart-container">
                    <div class="price-display">
                        <div class="current-price" id="currentPrice">-ì›</div>
                        <div class="price-change" id="priceChange">-ì› (--%)</div>
                        <div style="margin-top: 10px; color: #6c757d;">
                            <span id="selectedStockName">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</span> | 
                            <span id="selectedStockCode">-</span> | 
                            <span id="selectedStockSector">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- ê±°ë˜ íŒ¨ë„ -->
                <div class="trading-panel">
                    <h4 style="margin-bottom: 15px;">ğŸ’³ ì£¼ì‹ ê±°ë˜</h4>
                    <div class="trade-form">
                        <div class="form-group">
                            <label>ê±°ë˜ ìœ í˜•</label>
                            <select id="tradeType">
                                <option value="BUY">ë§¤ìˆ˜</option>
                                <option value="SELL">ë§¤ë„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìˆ˜ëŸ‰</label>
                            <input type="number" id="tradeQuantity" min="1" placeholder="ìˆ˜ëŸ‰">
                        </div>
                        <button class="btn btn-buy" id="executeTradeBtn" onclick="executeTrade()" disabled>
                            ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        ì˜ˆìƒ ê¸ˆì•¡: <span id="estimatedAmount">0ì›</span>
                    </div>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ -->
            <div class="panel players-panel">
                <h3>ğŸ‘¥ í”Œë ˆì´ì–´ ìˆœìœ„</h3>
                <div id="playersList" class="player-list">
                    <div class="loading">í”Œë ˆì´ì–´ ì •ë³´ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ íŒ¨ë„ë“¤ -->
        <div class="bottom-panels">
            <!-- ê±°ë˜ ë‚´ì—­ -->
            <div class="panel">
                <h3>ğŸ“‹ ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
                <div id="tradeHistory" class="trade-history">
                    <div class="loading">ê±°ë˜ ë‚´ì—­ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ì±„íŒ… -->
            <div class="panel">
                <h3>ğŸ’¬ ê²Œì„ ì±„íŒ…</h3>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <div class="chat-message">
                            <div class="chat-sender">ì‹œìŠ¤í…œ</div>
                            <div class="chat-text">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! í–‰ìš´ì„ ë¹•ë‹ˆë‹¤! ğŸ€</div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="100">
                        <button class="btn" onclick="sendChatMessage()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = localStorage.getItem('token');
        let gameId = null;
        let currentUser = null;
        let currentPlayer = null;
        let gameData = null;
        let selectedStock = null;
        let stocksData = {};
        let availableStocks = []; 
        let gameUpdateInterval = null;
        let roundTimeRemaining = 300; // 5ë¶„ = 300ì´ˆ

        // ì´ˆê¸°í™”
        window.onload = function() {
            console.log("=== í˜ì´ì§€ ë¡œë“œë¨ ===");
            console.log("gameId:", new URLSearchParams(window.location.search).get('gameId'));
            console.log("currentToken:", currentToken);
            
            initializeGame();
        };

        // ê²Œì„ ì´ˆê¸°í™”
        function initializeGame() {
            // URLì—ì„œ ê²Œì„ ID ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            gameId = urlParams.get('gameId');
            
            if (!gameId) {
                showError('ê²Œì„ IDê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ê²Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            if (!currentToken) {
                showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            // í† í° ê²€ì¦ ë° ê²Œì„ ë¡œë“œ
            verifyTokenAndLoadGame();
            
            // ì±„íŒ… ì…ë ¥ ì—”í„°í‚¤ ì´ë²¤íŠ¸
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // ê±°ë˜ ìœ í˜• ë³€ê²½ ì‹œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            document.getElementById('tradeType').addEventListener('change', updateTradeButton);
            
            // ìˆ˜ëŸ‰ ì…ë ¥ ì‹œ ì˜ˆìƒ ê¸ˆì•¡ ê³„ì‚°
            document.getElementById('tradeQuantity').addEventListener('input', calculateEstimatedAmount);
        }

        // í† í° ê²€ì¦ ë° ê²Œì„ ë°ì´í„° ë¡œë“œ
        async function verifyTokenAndLoadGame() {
            try {
                // í† í° ê²€ì¦
                const verifyResponse = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });

                const verifyData = await verifyResponse.json();
                
                if (!verifyData.success) {
                    throw new Error('í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                currentUser = verifyData.data.user;
                
                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
                updateUserDisplay();
                
                // ê²Œì„ ë°ì´í„° ë¡œë“œ
                await loadGameData();
                
                // ì •ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
                startGameUpdates();
                
                // ë¼ìš´ë“œ íƒ€ì´ë¨¸ ì‹œì‘
                startRoundTimer();
                
            } catch (error) {
                showError('ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
                updateUserDisplayError();
                setTimeout(() => {
                    window.location.href = 'game-test.html';
                }, 3000);
            }
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userEmail').textContent = currentUser.email || 'ì‚¬ìš©ì';
                document.getElementById('userId').textContent = `ì‚¬ìš©ì ID: ${currentUser.id || '-'}`;
                
                // ì•„ë°”íƒ€ì— ì´ë©”ì¼ ì²« ê¸€ì í‘œì‹œ
                const firstChar = (currentUser.email || 'U').charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstChar;
                
                // ì¸ì¦ ìƒíƒœ ì—…ë°ì´íŠ¸
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = '<span>ğŸ” ì¸ì¦ë¨</span>';
                authStatus.classList.remove('error');
            }
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—ëŸ¬ ìƒíƒœ
        function updateUserDisplayError() {
            document.getElementById('userEmail').textContent = 'ì¸ì¦ ì‹¤íŒ¨';
            document.getElementById('userId').textContent = 'ì‚¬ìš©ì ID: -';
            document.getElementById('userAvatar').textContent = '!';
            
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = '<span>âŒ ì¸ì¦ ì‹¤íŒ¨</span>';
            authStatus.classList.add('error');
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('token');
                currentToken = null;
                currentUser = null;
                
                // ì—…ë°ì´íŠ¸ ì¸í„°ë²Œ ì •ë¦¬
                if (gameUpdateInterval) {
                    clearInterval(gameUpdateInterval);
                }
                
                // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'game-test.html';
            }
        }

        // ê²Œì„ ë°ì´í„° ë¡œë“œ
        async function loadGameData() {
            
            try {                
                const [gameResponse, playersResponse, stocksResponse] = await Promise.all([
                    fetch(`${API_BASE}/games/${gameId}`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/games/${gameId}/players`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/games/${gameId}/stocks`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    })
                ]);

                
                const gameDataResponse = await gameResponse.json();
                const playersData = await playersResponse.json();
                const stocksDataResponse = await stocksResponse.json();

                
                if (gameDataResponse.success) {
                    this.gameData = gameDataResponse.data;
                    updateGameHeader(gameDataResponse.data);
                }

                if (playersData.success) {
                    updatePlayersData(playersData.data);
                }
                
                if (stocksDataResponse.success) {
                    updateStocksData(stocksDataResponse.data);
                    generateStockTabs(); 
                } else {
                }

                // ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ
                if (currentPlayer) {
                    await loadMyPortfolio();
                }

                // ê±°ë˜ ë‚´ì—­ ë¡œë“œ
                if (currentPlayer) {
                    await loadTradeHistory();
                }

            } catch (error) {
                console.error('âŒ loadGameData ì˜¤ë¥˜:', error);
                showError('ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ê²Œì„ í—¤ë” ì—…ë°ì´íŠ¸
        function updateGameHeader(game) {
            document.getElementById('gameTitle').textContent = `ğŸ” ${game.title}`;
            
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = game.status;
            statusElement.className = `game-status status-${game.status.toLowerCase()}`;
            
            document.getElementById('currentRound').textContent = 
                `${game.currentRound || 1}/${game.totalRounds || 10}`;
            
            document.getElementById('playerCount').textContent = 
                `${game.currentPlayers || 0}/4ëª…`;
        }

        // í”Œë ˆì´ì–´ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updatePlayersData(players) {
            currentPlayer = players.find(p => p.userId === currentUser.id);
            
            if (currentPlayer) {
                updateMyStats(currentPlayer);
            }
            
            updatePlayersRanking(players);
        }

        // ë‚´ í†µê³„ ì—…ë°ì´íŠ¸
        function updateMyStats(player) {
            document.getElementById('myCash').textContent = 
                (player.currentCash || 0).toLocaleString() + 'ì›';
            
            document.getElementById('myTotalAsset').textContent = 
                (player.totalAssetValue || 0).toLocaleString() + 'ì›';
            
            const profitLoss = player.profitLoss || 0;
            const profitLossElement = document.getElementById('myProfitLoss');
            profitLossElement.textContent = 
                (profitLoss >= 0 ? '+' : '') + profitLoss.toLocaleString() + 'ì›';
            profitLossElement.className = `stat-value ${profitLoss >= 0 ? 'positive' : 'negative'}`;
            
            // profitRateë¥¼ ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜
            const profitRate = Number(player.profitRate) || 0;
            const profitRateElement = document.getElementById('myProfitRate');
            profitRateElement.textContent = 
                (profitRate >= 0 ? '+' : '') + profitRate.toFixed(2) + '%';
            profitRateElement.className = `stat-value ${profitRate >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('myRanking').textContent = 
                (player.ranking || '-') + 'ìœ„';
        }

        // í”Œë ˆì´ì–´ ìˆœìœ„ ì—…ë°ì´íŠ¸
        function updatePlayersRanking(players) {
            const container = document.getElementById('playersList');
            
            // ìˆœìœ„ë³„ë¡œ ì •ë ¬
            players.sort((a, b) => (a.ranking || 999) - (b.ranking || 999));
            
            container.innerHTML = '';
            players.forEach(player => {
                const isCurrentUser = player.userId === currentUser.id;
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${isCurrentUser ? 'current-user' : ''}`;
                
                // profitRateë¥¼ ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜
                const profitRate = Number(player.profitRate) || 0;
                playerCard.innerHTML = `
                    <div class="player-name">
                        ${player.ranking || '-'}ìœ„. ${player.nickname} ${isCurrentUser ? '(ë‚˜)' : ''}
                    </div>
                    <div class="player-stats">
                        <div class="player-stat">
                            <span>ì´ ìì‚°</span>
                            <span>${(player.totalAssetValue || 0).toLocaleString()}ì›</span>
                        </div>
                        <div class="player-stat">
                            <span>ìˆ˜ìµë¥ </span>
                            <span class="${profitRate >= 0 ? 'positive' : 'negative'}">
                                ${(profitRate >= 0 ? '+' : '') + profitRate.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(playerCard);
            });
        }

        // ì£¼ì‹ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateStocksData(stocks) {
            
            stocksData = {};
            availableStocks = [];
            
            if (!stocks || !Array.isArray(stocks)) {
                return;
            }
            
            
            stocks.forEach((stock, index) => {
                
                if (!stock || !stock.stockCode) {
                    return;
                }
                
                stocksData[stock.stockCode] = stock;
                
                // ì•ˆì „í•œ í…œí”Œë¦¿ ì ‘ê·¼
                const stockTemplate = stock.stockTemplate || {};
                const stockInfo = {
                    code: stock.stockCode,
                    name: stockTemplate.name || stock.stockCode,
                    sector: stockTemplate.sector || 'Unknown',
                    currentPrice: Number(stock.currentPrice) || 0,
                    initialPrice: Number(stock.initialPrice) || 0
                };
                
                availableStocks.push(stockInfo);
            });
            
            // í˜„ì¬ ì„ íƒëœ ì£¼ì‹ ì •ë³´ ì—…ë°ì´íŠ¸
            if (selectedStock) {
                updateSelectedStockDisplay();
            }
        }

        function generateStockTabs() {
            const tabsContainer = document.getElementById('stockTabs');
            
            if (availableStocks.length === 0) {
                tabsContainer.innerHTML = '<div class="loading">ì£¼ì‹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            tabsContainer.innerHTML = '';
            
            availableStocks.forEach((stock, index) => {
                
                const tab = document.createElement('button');
                tab.className = `stock-tab ${index === 0 ? 'active' : ''}`;
                tab.dataset.stock = stock.code;
                tab.textContent = stock.name;
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                tab.addEventListener('click', function() {
                    
                    // í™œì„± íƒ­ ë³€ê²½
                    document.querySelectorAll('.stock-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ì„ íƒëœ ì£¼ì‹ ë³€ê²½
                    selectedStock = this.dataset.stock;
                    
                    updateSelectedStockDisplay();
                    updateTradeButton();
                });
                
                tabsContainer.appendChild(tab);
                
                // ì²« ë²ˆì§¸ ì£¼ì‹ì„ ê¸°ë³¸ ì„ íƒ
                if (index === 0) {
                    selectedStock = stock.code;
                    updateSelectedStockDisplay();
                    updateTradeButton();
                }
            });
            
        }

        // ì„ íƒëœ ì£¼ì‹ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSelectedStockDisplay() {
            const stock = stocksData[selectedStock];
            if (!stock) {
                // ì„ íƒëœ ì£¼ì‹ì´ ì—†ì„ ë•Œ ê¸°ë³¸ í‘œì‹œ
                document.getElementById('currentPrice').textContent = '-ì›';
                document.getElementById('priceChange').textContent = '-ì› (-%)';
                document.getElementById('selectedStockName').textContent = 'ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”';
                document.getElementById('selectedStockCode').textContent = '-';
                document.getElementById('selectedStockSector').textContent = '-';
                return;
            }
            
            const currentPrice = Number(stock.currentPrice) || 0;
            const initialPrice = Number(stock.initialPrice) || 1;
            const priceChange = currentPrice - initialPrice;
            const changePercent = (priceChange / initialPrice * 100);
            
            document.getElementById('currentPrice').textContent = currentPrice.toLocaleString() + 'ì›';
            document.getElementById('currentPrice').className = 
                `current-price ${priceChange >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('priceChange').textContent = 
                (priceChange >= 0 ? '+' : '') + priceChange.toLocaleString() + 'ì› (' +
                (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%)';
            document.getElementById('priceChange').className = 
                `price-change ${priceChange >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('selectedStockName').textContent = stock.stockTemplate?.name || stock.stockCode;
            document.getElementById('selectedStockCode').textContent = stock.stockCode;
            document.getElementById('selectedStockSector').textContent = stock.stockTemplate?.sector || '-';
            
            // ì˜ˆìƒ ê¸ˆì•¡ ê³„ì‚°
            calculateEstimatedAmount();
        }

        // ê±°ë˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateTradeButton() {
            const tradeType = document.getElementById('tradeType').value;
            const button = document.getElementById('executeTradeBtn');
            
            if (!selectedStock) {
                button.textContent = 'ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”';
                button.disabled = true;
                button.className = 'btn';
                return;
            }
            
            button.disabled = false;
            
            if (tradeType === 'BUY') {
                button.textContent = 'ë§¤ìˆ˜';
                button.className = 'btn btn-buy';
            } else {
                button.textContent = 'ë§¤ë„';
                button.className = 'btn btn-sell';
            }
        }

        // ì˜ˆìƒ ê¸ˆì•¡ ê³„ì‚°
        function calculateEstimatedAmount() {
            const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
            const stock = stocksData[selectedStock];
            
            if (stock && quantity > 0) {
                const currentPrice = Number(stock.currentPrice) || 0;
                const estimatedAmount = quantity * currentPrice;
                document.getElementById('estimatedAmount').textContent = estimatedAmount.toLocaleString() + 'ì›';
            } else {
                document.getElementById('estimatedAmount').textContent = '0ì›';
            }
        }

        // ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ
        async function loadMyPortfolio() {
            if (!currentPlayer) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/portfolio?playerId=${currentPlayer.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    updatePortfolioDisplay(data.data);
                } else {
                    document.getElementById('myPortfolio').innerHTML = '<div class="loading">í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('myPortfolio').innerHTML = '<div class="loading">í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updatePortfolioDisplay(portfolio) {
            const container = document.getElementById('myPortfolio');
            
            if (!portfolio.holdings || portfolio.holdings.length === 0) {
                container.innerHTML = '<div class="loading">ë³´ìœ  ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = '';
            portfolio.holdings.forEach(holding => {
                const stock = stocksData[holding.stockCode];
                const stockTemplate = availableStocks.find(s => s.code === holding.stockCode);
                const currentPrice = stock ? Number(stock.currentPrice) : 0;
                const totalValue = holding.quantity * currentPrice;
                
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                item.innerHTML = `
                    <div>
                        <div class="portfolio-stock">${stockTemplate ? stockTemplate.name : holding.stockCode}</div>
                        <div class="portfolio-quantity">${holding.quantity}ì£¼</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold;">${totalValue.toLocaleString()}ì›</div>
                        <div style="font-size: 0.8em; color: #6c757d;">${currentPrice.toLocaleString()}ì›/ì£¼</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // ê±°ë˜ ë‚´ì—­ ë¡œë“œ
        async function loadTradeHistory() {
            if (!currentPlayer) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/trades/history?playerId=${currentPlayer.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    updateTradeHistoryDisplay(data.data);
                } else {
                    document.getElementById('tradeHistory').innerHTML = '<div class="loading">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('tradeHistory').innerHTML = '<div class="loading">ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // ê±°ë˜ ë‚´ì—­ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTradeHistoryDisplay(trades) {
            const container = document.getElementById('tradeHistory');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="loading">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = '';
            // ìµœê·¼ ê±°ë˜ë¶€í„° í‘œì‹œ (ìµœëŒ€ 10ê°œ)
            trades.slice(-10).reverse().forEach(trade => {
                const stockTemplate = availableStocks.find(s => s.code === trade.stockCode);
                const stockName = stockTemplate ? stockTemplate.name : trade.stockCode;
                const tradePrice = Number(trade.price) || 0;
                const tradeQuantity = Number(trade.quantity) || 0;
                
                const item = document.createElement('div');
                item.className = `trade-item trade-${trade.type.toLowerCase()}`;
                
                const tradeTime = new Date(trade.executedAt).toLocaleTimeString();
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${trade.type === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</strong> ${stockName}
                            <div style="font-size: 0.8em; color: #6c757d;">${tradeTime}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${tradeQuantity}ì£¼</div>
                            <div style="font-size: 0.8em;">${tradePrice.toLocaleString()}ì›/ì£¼</div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // ì£¼ì‹ ê±°ë˜ ì‹¤í–‰
        async function executeTrade() {
            if (!currentPlayer) {
                showError('í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!selectedStock) {
                showError('ê±°ë˜í•  ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const tradeType = document.getElementById('tradeType').value;
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            
            if (!quantity || quantity <= 0) {
                showError('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/trades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer.id,
                        stockCode: selectedStock,
                        type: tradeType,
                        quantity: quantity
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const stockName = availableStocks.find(s => s.code === selectedStock)?.name || selectedStock;
                    showSuccess(`${tradeType === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ê±°ë˜ê°€ ì²´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! (${stockName})`);
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('tradeQuantity').value = '';
                    calculateEstimatedAmount();
                    
                    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await loadGameData();
                    
                    // ì±„íŒ…ì— ê±°ë˜ ì•Œë¦¼ ì¶”ê°€ (ì„ íƒì )
                    addChatMessage('ì‹œìŠ¤í…œ', `${currentPlayer.nickname}ë‹˜ì´ ${stockName} ${quantity}ì£¼ë¥¼ ${tradeType === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}í–ˆìŠµë‹ˆë‹¤.`);
                    
                } else {
                    showError('ê±°ë˜ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                showError('ê±°ë˜ ìš”ì²­ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // í˜„ì¬ëŠ” ë¡œì»¬ ì±„íŒ…ë§Œ êµ¬í˜„ (ì‹¤ì œë¡œëŠ” ì„œë²„ë¡œ ì „ì†¡)
            addChatMessage(currentPlayer?.nickname || 'ë‚˜', message);
            input.value = '';
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(sender, message) {
            const container = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `
                <div class="chat-sender">${sender}</div>
                <div class="chat-text">${message}</div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // ì •ê¸°ì  ê²Œì„ ì—…ë°ì´íŠ¸ ì‹œì‘
        function startGameUpdates() {
            gameUpdateInterval = setInterval(async () => {
                try {
                    await loadGameData();
                } catch (error) {
                    console.error('ê²Œì„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }, 5000); // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }

        // ë¼ìš´ë“œ íƒ€ì´ë¨¸ ì‹œì‘
        function startRoundTimer() {
            setInterval(() => {
                if (roundTimeRemaining > 0) {
                    roundTimeRemaining--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimerDisplay() {
            const minutes = Math.floor(roundTimeRemaining / 60);
            const seconds = roundTimeRemaining % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timeRemaining').textContent = timeString;
            
            const timerElement = document.getElementById('roundTimer');
            timerElement.classList.remove('timer-warning', 'timer-danger');
            
            if (roundTimeRemaining <= 30) {
                timerElement.classList.add('timer-danger');
            } else if (roundTimeRemaining <= 60) {
                timerElement.classList.add('timer-warning');
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (gameUpdateInterval) {
                clearInterval(gameUpdateInterval);
            }
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            document.body.insertBefore(errorDiv, document.body.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            document.body.insertBefore(successDiv, document.body.firstChild);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ë™ì  ì£¼ì‹ ëª©ë¡ì— ë§ê²Œ ìˆ˜ì •)
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return; // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë¬´ì‹œ
            
            switch(e.key) {
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                    const stockTabs = document.querySelectorAll('.stock-tab');
                    const index = parseInt(e.key) - 1;
                    if (stockTabs[index]) {
                        stockTabs[index].click();
                    }
                    break;
                case 'b':
                case 'B':
                    document.getElementById('tradeType').value = 'BUY';
                    updateTradeButton();
                    break;
                case 's':
                case 'S':
                    document.getElementById('tradeType').value = 'SELL';
                    updateTradeButton();
                    break;
                case 'Enter':
                    if (e.ctrlKey) {
                        executeTrade();
                    }
                    break;
            }
        });
    </script>
</body>
</html>