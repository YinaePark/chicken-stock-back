<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>치킨스톡게임</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .user-header {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-email {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 0.8em;
            color: #6c757d;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 20px;
            color: #155724;
            font-size: 0.9em;
        }

        .auth-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .game-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .game-header h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .info-card strong {
            display: block;
            margin-bottom: 5px;
            color: #495057;
        }

        .game-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-playing { background: #28a745; color: white; }
        .status-waiting { background: #ffc107; color: #212529; }
        .status-finished { background: #dc3545; color: white; }

        .round-timer {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .timer-warning { background: #fff3cd !important; color: #856404 !important; }
        .timer-danger { background: #f8d7da !important; color: #721c24 !important; }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr 250px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .my-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .stat-value {
            font-weight: bold;
        }

        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        .portfolio-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .portfolio-stock {
            font-weight: bold;
            color: #2c3e50;
        }

        .portfolio-quantity {
            font-size: 0.9em;
            color: #6c757d;
        }

        .main-panel {
            min-height: 600px;
        }

        .stock-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stock-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            min-width: 120px;
        }

        .stock-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .stock-tab.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .price-display {
            margin-bottom: 15px;
        }

        .current-price {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .price-change {
            font-size: 1.1em;
            font-weight: 500;
        }

        .trading-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .trade-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: #495057;
        }

        .form-group select,
        .form-group input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-buy {
            background: #28a745;
            color: white;
        }

        .btn-buy:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-sell {
            background: #dc3545;
            color: white;
        }

        .btn-sell:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .players-panel {
            max-height: 600px;
            overflow-y: auto;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #6c757d;
        }

        .player-card.current-user {
            border-left-color: #3498db;
            background: #e3f2fd;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .player-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .bottom-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .trade-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .trade-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .trade-buy {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .trade-sell {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
        }

        .chat-sender {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 2px;
        }

        .chat-text {
            color: #495057;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 1200px) {
            .game-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .bottom-panels {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .stock-selector {
                flex-direction: column;
            }
            
            .stock-tab {
                min-width: auto;
            }

            .user-header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 사용자 정보 헤더 -->
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-email" id="userEmail">로딩 중...</div>
                    <div class="user-id" id="userId">사용자 ID: -</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="auth-status" id="authStatus">
                    <span>🔐 인증됨</span>
                </div>
                <button class="logout-btn" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <!-- 게임 헤더 -->
        <div class="game-header">
            <h1 id="gameTitle">🐔 치킨스톡게임</h1>
            <div class="game-info">
                <div class="info-card">
                    <strong>게임 상태</strong>
                    <span id="gameStatus" class="game-status status-playing">PLAYING</span>
                </div>
                <div class="info-card">
                    <strong>현재 라운드</strong>
                    <span id="currentRound">1/10</span>
                </div>
                <div class="info-card">
                    <strong>참가자</strong>
                    <span id="playerCount">4/4명</span>
                </div>
                <div class="info-card">
                    <strong>내 순위</strong>
                    <span id="myRanking">-위</span>
                </div>
            </div>
            
            <!-- 라운드 타이머 -->
            <div id="roundTimer" class="round-timer">
                남은 시간: <span id="timeRemaining">05:00</span>
            </div>
        </div>
        
        <!-- 메인 게임 레이아웃 -->
        <div class="game-layout">
            <!-- 왼쪽: 내 정보 패널 -->
            <div class="panel my-info">
                <h3>💰 내 정보</h3>
                <div class="my-stats">
                    <div class="stat-item">
                        <span class="stat-label">현금</span>
                        <span class="stat-value" id="myCash">1,000,000원</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">총 자산</span>
                        <span class="stat-value" id="myTotalAsset">1,000,000원</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">손익</span>
                        <span class="stat-value positive" id="myProfitLoss">+0원</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">수익률</span>
                        <span class="stat-value positive" id="myProfitRate">+0.00%</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">📊 내 포트폴리오</h3>
                <div id="myPortfolio" class="portfolio-grid">
                    <div class="loading">포트폴리오 로딩 중...</div>
                </div>
            </div>
            
            <!-- 중앙: 주식 차트 및 거래 패널 -->
            <div class="panel main-panel">
                <h3>📈 주식 거래</h3>
                
                <!-- 종목 선택 탭 -->
                <div id="stockTabs" class="stock-selector">
                    <div class="loading">주식 정보 로딩 중...</div>
                </div>
                
                <!-- 차트 영역 -->
                <div class="chart-container">
                    <div class="price-display">
                        <div class="current-price" id="currentPrice">-원</div>
                        <div class="price-change" id="priceChange">-원 (--%)</div>
                        <div style="margin-top: 10px; color: #6c757d;">
                            <span id="selectedStockName">종목을 선택하세요</span> | 
                            <span id="selectedStockCode">-</span> | 
                            <span id="selectedStockSector">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 거래 패널 -->
                <div class="trading-panel">
                    <h4 style="margin-bottom: 15px;">💳 주식 거래</h4>
                    <div class="trade-form">
                        <div class="form-group">
                            <label>거래 유형</label>
                            <select id="tradeType">
                                <option value="BUY">매수</option>
                                <option value="SELL">매도</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>수량</label>
                            <input type="number" id="tradeQuantity" min="1" placeholder="수량">
                        </div>
                        <button class="btn btn-buy" id="executeTradeBtn" onclick="executeTrade()" disabled>
                            종목을 선택하세요
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        예상 금액: <span id="estimatedAmount">0원</span>
                    </div>
                </div>
            </div>
            
            <!-- 오른쪽: 다른 플레이어들 -->
            <div class="panel players-panel">
                <h3>👥 플레이어 순위</h3>
                <div id="playersList" class="player-list">
                    <div class="loading">플레이어 정보 로딩 중...</div>
                </div>
            </div>
        </div>
        
        <!-- 하단 패널들 -->
        <div class="bottom-panels">
            <!-- 거래 내역 -->
            <div class="panel">
                <h3>📋 최근 거래 내역</h3>
                <div id="tradeHistory" class="trade-history">
                    <div class="loading">거래 내역 로딩 중...</div>
                </div>
            </div>
            
            <!-- 채팅 -->
            <div class="panel">
                <h3>💬 게임 채팅</h3>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <div class="chat-message">
                            <div class="chat-sender">시스템</div>
                            <div class="chat-text">게임이 시작되었습니다! 행운을 빕니다! 🍀</div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="메시지를 입력하세요..." maxlength="100">
                        <button class="btn" onclick="sendChatMessage()">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = localStorage.getItem('token');
        let gameId = null;
        let currentUser = null;
        let currentPlayer = null;
        let gameData = null;
        let selectedStock = null;
        let stocksData = {};
        let availableStocks = []; 
        let gameUpdateInterval = null;
        let roundTimeRemaining = 300; // 5분 = 300초

        // 초기화
        window.onload = function() {
            console.log("=== 페이지 로드됨 ===");
            console.log("gameId:", new URLSearchParams(window.location.search).get('gameId'));
            console.log("currentToken:", currentToken);
            
            initializeGame();
        };

        // 게임 초기화
        function initializeGame() {
            // URL에서 게임 ID 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            gameId = urlParams.get('gameId');
            
            if (!gameId) {
                showError('게임 ID가 없습니다. 메인 페이지에서 게임을 선택해주세요.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            if (!currentToken) {
                showError('로그인이 필요합니다. 메인 페이지에서 로그인해주세요.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            // 토큰 검증 및 게임 로드
            verifyTokenAndLoadGame();
            
            // 채팅 입력 엔터키 이벤트
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // 거래 유형 변경 시 버튼 스타일 변경
            document.getElementById('tradeType').addEventListener('change', updateTradeButton);
            
            // 수량 입력 시 예상 금액 계산
            document.getElementById('tradeQuantity').addEventListener('input', calculateEstimatedAmount);
        }

        // 토큰 검증 및 게임 데이터 로드
        async function verifyTokenAndLoadGame() {
            try {
                // 토큰 검증
                const verifyResponse = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });

                const verifyData = await verifyResponse.json();
                
                if (!verifyData.success) {
                    throw new Error('토큰이 유효하지 않습니다.');
                }
                
                currentUser = verifyData.data.user;
                
                // 사용자 정보 표시 업데이트
                updateUserDisplay();
                
                // 게임 데이터 로드
                await loadGameData();
                
                // 정기적 업데이트 시작
                startGameUpdates();
                
                // 라운드 타이머 시작
                startRoundTimer();
                
            } catch (error) {
                showError('게임 초기화 실패: ' + error.message);
                updateUserDisplayError();
                setTimeout(() => {
                    window.location.href = 'game-test.html';
                }, 3000);
            }
        }

        // 사용자 정보 표시 업데이트
        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userEmail').textContent = currentUser.email || '사용자';
                document.getElementById('userId').textContent = `사용자 ID: ${currentUser.id || '-'}`;
                
                // 아바타에 이메일 첫 글자 표시
                const firstChar = (currentUser.email || 'U').charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstChar;
                
                // 인증 상태 업데이트
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = '<span>🔐 인증됨</span>';
                authStatus.classList.remove('error');
            }
        }

        // 사용자 정보 표시 에러 상태
        function updateUserDisplayError() {
            document.getElementById('userEmail').textContent = '인증 실패';
            document.getElementById('userId').textContent = '사용자 ID: -';
            document.getElementById('userAvatar').textContent = '!';
            
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = '<span>❌ 인증 실패</span>';
            authStatus.classList.add('error');
        }

        // 로그아웃 함수
        function logout() {
            if (confirm('정말 로그아웃 하시겠습니까?')) {
                localStorage.removeItem('token');
                currentToken = null;
                currentUser = null;
                
                // 업데이트 인터벌 정리
                if (gameUpdateInterval) {
                    clearInterval(gameUpdateInterval);
                }
                
                // 메인 페이지로 이동
                window.location.href = 'game-test.html';
            }
        }

        // 게임 데이터 로드
        async function loadGameData() {
            
            try {                
                const [gameResponse, playersResponse, stocksResponse] = await Promise.all([
                    fetch(`${API_BASE}/games/${gameId}`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/games/${gameId}/players`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/games/${gameId}/stocks`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    })
                ]);

                
                const gameDataResponse = await gameResponse.json();
                const playersData = await playersResponse.json();
                const stocksDataResponse = await stocksResponse.json();

                
                if (gameDataResponse.success) {
                    this.gameData = gameDataResponse.data;
                    updateGameHeader(gameDataResponse.data);
                }

                if (playersData.success) {
                    updatePlayersData(playersData.data);
                }
                
                if (stocksDataResponse.success) {
                    updateStocksData(stocksDataResponse.data);
                    generateStockTabs(); 
                } else {
                }

                // 내 포트폴리오 로드
                if (currentPlayer) {
                    await loadMyPortfolio();
                }

                // 거래 내역 로드
                if (currentPlayer) {
                    await loadTradeHistory();
                }

            } catch (error) {
                console.error('❌ loadGameData 오류:', error);
                showError('게임 데이터 로드 실패: ' + error.message);
            }
        }

        // 게임 헤더 업데이트
        function updateGameHeader(game) {
            document.getElementById('gameTitle').textContent = `🐔 ${game.title}`;
            
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = game.status;
            statusElement.className = `game-status status-${game.status.toLowerCase()}`;
            
            document.getElementById('currentRound').textContent = 
                `${game.currentRound || 1}/${game.totalRounds || 10}`;
            
            document.getElementById('playerCount').textContent = 
                `${game.currentPlayers || 0}/4명`;
        }

        // 플레이어 데이터 업데이트
        function updatePlayersData(players) {
            currentPlayer = players.find(p => p.userId === currentUser.id);
            
            if (currentPlayer) {
                updateMyStats(currentPlayer);
            }
            
            updatePlayersRanking(players);
        }

        // 내 통계 업데이트
        function updateMyStats(player) {
            document.getElementById('myCash').textContent = 
                (player.currentCash || 0).toLocaleString() + '원';
            
            document.getElementById('myTotalAsset').textContent = 
                (player.totalAssetValue || 0).toLocaleString() + '원';
            
            const profitLoss = player.profitLoss || 0;
            const profitLossElement = document.getElementById('myProfitLoss');
            profitLossElement.textContent = 
                (profitLoss >= 0 ? '+' : '') + profitLoss.toLocaleString() + '원';
            profitLossElement.className = `stat-value ${profitLoss >= 0 ? 'positive' : 'negative'}`;
            
            // profitRate를 안전하게 숫자로 변환
            const profitRate = Number(player.profitRate) || 0;
            const profitRateElement = document.getElementById('myProfitRate');
            profitRateElement.textContent = 
                (profitRate >= 0 ? '+' : '') + profitRate.toFixed(2) + '%';
            profitRateElement.className = `stat-value ${profitRate >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('myRanking').textContent = 
                (player.ranking || '-') + '위';
        }

        // 플레이어 순위 업데이트
        function updatePlayersRanking(players) {
            const container = document.getElementById('playersList');
            
            // 순위별로 정렬
            players.sort((a, b) => (a.ranking || 999) - (b.ranking || 999));
            
            container.innerHTML = '';
            players.forEach(player => {
                const isCurrentUser = player.userId === currentUser.id;
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${isCurrentUser ? 'current-user' : ''}`;
                
                // profitRate를 안전하게 숫자로 변환
                const profitRate = Number(player.profitRate) || 0;
                playerCard.innerHTML = `
                    <div class="player-name">
                        ${player.ranking || '-'}위. ${player.nickname} ${isCurrentUser ? '(나)' : ''}
                    </div>
                    <div class="player-stats">
                        <div class="player-stat">
                            <span>총 자산</span>
                            <span>${(player.totalAssetValue || 0).toLocaleString()}원</span>
                        </div>
                        <div class="player-stat">
                            <span>수익률</span>
                            <span class="${profitRate >= 0 ? 'positive' : 'negative'}">
                                ${(profitRate >= 0 ? '+' : '') + profitRate.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(playerCard);
            });
        }

        // 주식 데이터 업데이트
        function updateStocksData(stocks) {
            
            stocksData = {};
            availableStocks = [];
            
            if (!stocks || !Array.isArray(stocks)) {
                return;
            }
            
            
            stocks.forEach((stock, index) => {
                
                if (!stock || !stock.stockCode) {
                    return;
                }
                
                stocksData[stock.stockCode] = stock;
                
                // 안전한 템플릿 접근
                const stockTemplate = stock.stockTemplate || {};
                const stockInfo = {
                    code: stock.stockCode,
                    name: stockTemplate.name || stock.stockCode,
                    sector: stockTemplate.sector || 'Unknown',
                    currentPrice: Number(stock.currentPrice) || 0,
                    initialPrice: Number(stock.initialPrice) || 0
                };
                
                availableStocks.push(stockInfo);
            });
            
            // 현재 선택된 주식 정보 업데이트
            if (selectedStock) {
                updateSelectedStockDisplay();
            }
        }

        function generateStockTabs() {
            const tabsContainer = document.getElementById('stockTabs');
            
            if (availableStocks.length === 0) {
                tabsContainer.innerHTML = '<div class="loading">주식 정보를 찾을 수 없습니다.</div>';
                return;
            }
            
            tabsContainer.innerHTML = '';
            
            availableStocks.forEach((stock, index) => {
                
                const tab = document.createElement('button');
                tab.className = `stock-tab ${index === 0 ? 'active' : ''}`;
                tab.dataset.stock = stock.code;
                tab.textContent = stock.name;
                
                // 클릭 이벤트 추가
                tab.addEventListener('click', function() {
                    
                    // 활성 탭 변경
                    document.querySelectorAll('.stock-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 선택된 주식 변경
                    selectedStock = this.dataset.stock;
                    
                    updateSelectedStockDisplay();
                    updateTradeButton();
                });
                
                tabsContainer.appendChild(tab);
                
                // 첫 번째 주식을 기본 선택
                if (index === 0) {
                    selectedStock = stock.code;
                    updateSelectedStockDisplay();
                    updateTradeButton();
                }
            });
            
        }

        // 선택된 주식 표시 업데이트
        function updateSelectedStockDisplay() {
            const stock = stocksData[selectedStock];
            if (!stock) {
                // 선택된 주식이 없을 때 기본 표시
                document.getElementById('currentPrice').textContent = '-원';
                document.getElementById('priceChange').textContent = '-원 (-%)';
                document.getElementById('selectedStockName').textContent = '종목을 선택하세요';
                document.getElementById('selectedStockCode').textContent = '-';
                document.getElementById('selectedStockSector').textContent = '-';
                return;
            }
            
            const currentPrice = Number(stock.currentPrice) || 0;
            const initialPrice = Number(stock.initialPrice) || 1;
            const priceChange = currentPrice - initialPrice;
            const changePercent = (priceChange / initialPrice * 100);
            
            document.getElementById('currentPrice').textContent = currentPrice.toLocaleString() + '원';
            document.getElementById('currentPrice').className = 
                `current-price ${priceChange >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('priceChange').textContent = 
                (priceChange >= 0 ? '+' : '') + priceChange.toLocaleString() + '원 (' +
                (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%)';
            document.getElementById('priceChange').className = 
                `price-change ${priceChange >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('selectedStockName').textContent = stock.stockTemplate?.name || stock.stockCode;
            document.getElementById('selectedStockCode').textContent = stock.stockCode;
            document.getElementById('selectedStockSector').textContent = stock.stockTemplate?.sector || '-';
            
            // 예상 금액 계산
            calculateEstimatedAmount();
        }

        // 거래 버튼 업데이트
        function updateTradeButton() {
            const tradeType = document.getElementById('tradeType').value;
            const button = document.getElementById('executeTradeBtn');
            
            if (!selectedStock) {
                button.textContent = '종목을 선택하세요';
                button.disabled = true;
                button.className = 'btn';
                return;
            }
            
            button.disabled = false;
            
            if (tradeType === 'BUY') {
                button.textContent = '매수';
                button.className = 'btn btn-buy';
            } else {
                button.textContent = '매도';
                button.className = 'btn btn-sell';
            }
        }

        // 예상 금액 계산
        function calculateEstimatedAmount() {
            const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
            const stock = stocksData[selectedStock];
            
            if (stock && quantity > 0) {
                const currentPrice = Number(stock.currentPrice) || 0;
                const estimatedAmount = quantity * currentPrice;
                document.getElementById('estimatedAmount').textContent = estimatedAmount.toLocaleString() + '원';
            } else {
                document.getElementById('estimatedAmount').textContent = '0원';
            }
        }

        // 내 포트폴리오 로드
        async function loadMyPortfolio() {
            if (!currentPlayer) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/portfolio?playerId=${currentPlayer.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    updatePortfolioDisplay(data.data);
                } else {
                    document.getElementById('myPortfolio').innerHTML = '<div class="loading">포트폴리오가 없습니다.</div>';
                }
            } catch (error) {
                console.error('포트폴리오 로드 실패:', error);
                document.getElementById('myPortfolio').innerHTML = '<div class="loading">포트폴리오 로드 실패</div>';
            }
        }

        // 포트폴리오 표시 업데이트
        function updatePortfolioDisplay(portfolio) {
            const container = document.getElementById('myPortfolio');
            
            if (!portfolio.holdings || portfolio.holdings.length === 0) {
                container.innerHTML = '<div class="loading">보유 주식이 없습니다.</div>';
                return;
            }
            
            container.innerHTML = '';
            portfolio.holdings.forEach(holding => {
                const stock = stocksData[holding.stockCode];
                const stockTemplate = availableStocks.find(s => s.code === holding.stockCode);
                const currentPrice = stock ? Number(stock.currentPrice) : 0;
                const totalValue = holding.quantity * currentPrice;
                
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                item.innerHTML = `
                    <div>
                        <div class="portfolio-stock">${stockTemplate ? stockTemplate.name : holding.stockCode}</div>
                        <div class="portfolio-quantity">${holding.quantity}주</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold;">${totalValue.toLocaleString()}원</div>
                        <div style="font-size: 0.8em; color: #6c757d;">${currentPrice.toLocaleString()}원/주</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 거래 내역 로드
        async function loadTradeHistory() {
            if (!currentPlayer) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/trades/history?playerId=${currentPlayer.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    updateTradeHistoryDisplay(data.data);
                } else {
                    document.getElementById('tradeHistory').innerHTML = '<div class="loading">거래 내역이 없습니다.</div>';
                }
            } catch (error) {
                console.error('거래 내역 로드 실패:', error);
                document.getElementById('tradeHistory').innerHTML = '<div class="loading">거래 내역 로드 실패</div>';
            }
        }

        // 거래 내역 표시 업데이트
        function updateTradeHistoryDisplay(trades) {
            const container = document.getElementById('tradeHistory');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="loading">거래 내역이 없습니다.</div>';
                return;
            }
            
            container.innerHTML = '';
            // 최근 거래부터 표시 (최대 10개)
            trades.slice(-10).reverse().forEach(trade => {
                const stockTemplate = availableStocks.find(s => s.code === trade.stockCode);
                const stockName = stockTemplate ? stockTemplate.name : trade.stockCode;
                const tradePrice = Number(trade.price) || 0;
                const tradeQuantity = Number(trade.quantity) || 0;
                
                const item = document.createElement('div');
                item.className = `trade-item trade-${trade.type.toLowerCase()}`;
                
                const tradeTime = new Date(trade.executedAt).toLocaleTimeString();
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${trade.type === 'BUY' ? '매수' : '매도'}</strong> ${stockName}
                            <div style="font-size: 0.8em; color: #6c757d;">${tradeTime}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${tradeQuantity}주</div>
                            <div style="font-size: 0.8em;">${tradePrice.toLocaleString()}원/주</div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 주식 거래 실행
        async function executeTrade() {
            if (!currentPlayer) {
                showError('플레이어 정보를 찾을 수 없습니다.');
                return;
            }
            
            if (!selectedStock) {
                showError('거래할 종목을 선택해주세요.');
                return;
            }
            
            const tradeType = document.getElementById('tradeType').value;
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            
            if (!quantity || quantity <= 0) {
                showError('올바른 수량을 입력해주세요.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/trades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer.id,
                        stockCode: selectedStock,
                        type: tradeType,
                        quantity: quantity
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const stockName = availableStocks.find(s => s.code === selectedStock)?.name || selectedStock;
                    showSuccess(`${tradeType === 'BUY' ? '매수' : '매도'} 거래가 체결되었습니다! (${stockName})`);
                    
                    // 폼 초기화
                    document.getElementById('tradeQuantity').value = '';
                    calculateEstimatedAmount();
                    
                    // 데이터 새로고침
                    await loadGameData();
                    
                    // 채팅에 거래 알림 추가 (선택적)
                    addChatMessage('시스템', `${currentPlayer.nickname}님이 ${stockName} ${quantity}주를 ${tradeType === 'BUY' ? '매수' : '매도'}했습니다.`);
                    
                } else {
                    showError('거래 실패: ' + (data.error || '알 수 없는 오류'));
                }
            } catch (error) {
                showError('거래 요청 실패: ' + error.message);
            }
        }

        // 채팅 메시지 전송
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 현재는 로컬 채팅만 구현 (실제로는 서버로 전송)
            addChatMessage(currentPlayer?.nickname || '나', message);
            input.value = '';
        }

        // 채팅 메시지 추가
        function addChatMessage(sender, message) {
            const container = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `
                <div class="chat-sender">${sender}</div>
                <div class="chat-text">${message}</div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // 정기적 게임 업데이트 시작
        function startGameUpdates() {
            gameUpdateInterval = setInterval(async () => {
                try {
                    await loadGameData();
                } catch (error) {
                    console.error('게임 업데이트 실패:', error);
                }
            }, 5000); // 5초마다 업데이트
        }

        // 라운드 타이머 시작
        function startRoundTimer() {
            setInterval(() => {
                if (roundTimeRemaining > 0) {
                    roundTimeRemaining--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        // 타이머 표시 업데이트
        function updateTimerDisplay() {
            const minutes = Math.floor(roundTimeRemaining / 60);
            const seconds = roundTimeRemaining % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timeRemaining').textContent = timeString;
            
            const timerElement = document.getElementById('roundTimer');
            timerElement.classList.remove('timer-warning', 'timer-danger');
            
            if (roundTimeRemaining <= 30) {
                timerElement.classList.add('timer-danger');
            } else if (roundTimeRemaining <= 60) {
                timerElement.classList.add('timer-warning');
            }
        }

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            if (gameUpdateInterval) {
                clearInterval(gameUpdateInterval);
            }
        });

        // 유틸리티 함수들
        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            document.body.insertBefore(errorDiv, document.body.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            document.body.insertBefore(successDiv, document.body.firstChild);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // 키보드 단축키 (동적 주식 목록에 맞게 수정)
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return; // 입력 필드에서는 무시
            
            switch(e.key) {
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                    const stockTabs = document.querySelectorAll('.stock-tab');
                    const index = parseInt(e.key) - 1;
                    if (stockTabs[index]) {
                        stockTabs[index].click();
                    }
                    break;
                case 'b':
                case 'B':
                    document.getElementById('tradeType').value = 'BUY';
                    updateTradeButton();
                    break;
                case 's':
                case 'S':
                    document.getElementById('tradeType').value = 'SELL';
                    updateTradeButton();
                    break;
                case 'Enter':
                    if (e.ctrlKey) {
                        executeTrade();
                    }
                    break;
            }
        });
    </script>
</body>
</html>