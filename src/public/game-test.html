<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏπòÌÇ®Ïä§ÌÜ°Í≤åÏûÑ API ÌÖåÏä§Ìä∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .user-status {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-item strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .logged-in {
            color: #51cf66;
        }
        
        .logged-out {
            color: #ff6b6b;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
        }
        
        .tab:hover {
            background: #dee2e6;
        }
        
        .tab.active:hover {
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-section h3 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffd93d, #ff9500);
        }
        
        .game-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .game-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .game-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .game-detail {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-item strong {
            display: block;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status.waiting {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status.playing {
            background: #00b894;
            color: white;
        }
        
        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stock-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: box-shadow 0.3s;
        }
        
        .stock-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .price-change {
            font-weight: bold;
        }
        
        .price-change.positive {
            color: #00b894;
        }
        
        .price-change.negative {
            color: #e17055;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .player-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        
        .player-card.current-user {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .trade-section {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .trade-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .response {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #667eea;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success {
            background: #51cf66;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .warning {
            background: #ffd93d;
            color: #333;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .token-display {
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêî ÏπòÌÇ®Ïä§ÌÜ°Í≤åÏûÑ API ÌÖåÏä§Ìä∏</h1>
            <p>Ïã§ÏãúÍ∞Ñ Ï£ºÏãù Í±∞Îûò ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤åÏûÑ</p>
            
            <div class="user-status">
                <div class="status-item">
                    <strong>Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú</strong>
                    <span id="loginStatus" class="logged-out">Î°úÍ∑∏ÏïÑÏõÉ</span>
                </div>
                <div class="status-item">
                    <strong>ÏÇ¨Ïö©Ïûê Ïù¥Î©îÏùº</strong>
                    <span id="userEmail">-</span>
                </div>
                <div class="status-item">
                    <strong>ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ ID</strong>
                    <span id="currentPlayerId">-</span>
                </div>
                <div class="status-item">
                    <strong>ÏÑ†ÌÉùÎêú Í≤åÏûÑ</strong>
                    <span id="selectedGameId">-</span>
                </div>
                <div class="status-item">
                    <strong>JWT ÌÜ†ÌÅ∞</strong>
                    <div class="token-display" id="tokenDisplay">-</div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('auth')">Î°úÍ∑∏Ïù∏ & Í≤åÏûÑ ÏÉùÏÑ±</button>
            <button class="tab" onclick="showTab('game')">ÎÇ¥ Í≤åÏûÑ Í¥ÄÎ¶¨</button>
        </div>
        
        <!-- Ï≤´Î≤àÏß∏ ÌÉ≠: Î°úÍ∑∏Ïù∏ & Í≤åÏûÑ ÏÉùÏÑ± -->
        <div id="auth-tab" class="tab-content active">
            <div class="form-section">
                <h3>üîê Ïù∏Ï¶ù</h3>
                
                <!-- ÏàòÎèô ÌÜ†ÌÅ∞ ÏûÖÎ†• -->
                <div class="form-group">
                    <label>ÏàòÎèô JWT ÌÜ†ÌÅ∞ ÏûÖÎ†•</label>
                    <input type="text" id="manualToken" placeholder="JWT ÌÜ†ÌÅ∞ÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <button class="btn btn-warning" onclick="setManualToken()">ÌÜ†ÌÅ∞ ÏÑ§Ï†ï</button>
                </div>
                
                <!-- ÌöåÏõêÍ∞ÄÏûÖ -->
                <div class="form-group">
                    <label>ÌöåÏõêÍ∞ÄÏûÖ</label>
                    <input type="email" id="registerEmail" placeholder="Ïù¥Î©îÏùº">
                    <input type="password" id="registerPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
                    <input type="text" id="registerNickname" placeholder="ÎãâÎÑ§ÏûÑ">
                    <button class="btn" onclick="register()">ÌöåÏõêÍ∞ÄÏûÖ</button>
                </div>
                
                <!-- Î°úÍ∑∏Ïù∏ -->
                <div class="form-group">
                    <label>Î°úÍ∑∏Ïù∏</label>
                    <input type="email" id="loginEmail" placeholder="Ïù¥Î©îÏùº">
                    <input type="password" id="loginPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
                    <button class="btn" onclick="login()">Î°úÍ∑∏Ïù∏</button>
                    <button class="btn btn-danger" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>
            
            <div class="form-section">
                <h3>üéÆ Í≤åÏûÑ Í¥ÄÎ¶¨</h3>
                
                <!-- Í≤åÏûÑ ÏÉùÏÑ± -->
                <div class="form-group">
                    <label>Í≤åÏûÑ ÏÉùÏÑ±</label>
                    <input type="text" id="gameTitle" placeholder="Í≤åÏûÑ Ï†úÎ™©">
                    <button class="btn" onclick="createGame()" id="createGameBtn">Í≤åÏûÑ ÏÉùÏÑ±</button>
                </div>
                
                <!-- Í≤åÏûÑ Ï∞∏Í∞Ä -->
                <div class="form-group">
                    <label>Í≤åÏûÑ Ï∞∏Í∞Ä</label>
                    <input type="text" id="joinGameId" placeholder="Í≤åÏûÑ ID">
                    <input type="text" id="joinNickname" placeholder="Í≤åÏûÑ ÎãâÎÑ§ÏûÑ">
                    <button class="btn" onclick="joinGame()" id="joinGameBtn">Í≤åÏûÑ Ï∞∏Í∞Ä</button>
                </div>
                
                <button class="btn btn-success" onclick="loadAllGames()">Î™®Îì† Í≤åÏûÑ Î™©Î°ù Î≥¥Í∏∞</button>
            </div>
            
            <!-- API ÏùëÎãµ -->
            <div class="form-section">
                <h3>üìÑ API ÏùëÎãµ</h3>
                <div id="apiResponse" class="response">API ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>
            </div>
        </div>
        
        <!-- ÎëêÎ≤àÏß∏ ÌÉ≠: ÎÇ¥ Í≤åÏûÑ Í¥ÄÎ¶¨ -->
        <div id="game-tab" class="tab-content">
            <div class="form-section">
                <h3>üéØ ÎÇ¥Í∞Ä Ï∞∏Í∞ÄÌïú Í≤åÏûÑ Î™©Î°ù</h3>
                <button class="btn btn-success" onclick="loadMyGames()">ÎÇ¥ Í≤åÏûÑ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®</button>
                <div id="myGamesList" class="game-list">
                    <div class="loading">Î°úÍ∑∏Ïù∏ ÌõÑ Í≤åÏûÑ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏÑ∏Ïöî.</div>
                </div>
            </div>
            
            <!-- ÏÑ†ÌÉùÎêú Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
            <div id="gameDetailSection">
                <div class="form-section">
                    <h3>üéÆ Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3>
                    <div id="gameDetail" class="game-detail"></div>
                    <!-- Ìò∏Ïä§Ìä∏ Ï†ÑÏö© Ïª®Ìä∏Î°§ -->
                    <div id="hostControls" class="hidden" style="margin-top: 20px;">
                        <h4>üéØ Ìò∏Ïä§Ìä∏ Ï†ÑÏö© Ïª®Ìä∏Î°§</h4>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                            <button class="btn btn-success" onclick="startGame()" id="startGameBtn">Í≤åÏûÑ ÏãúÏûë</button>
                            <button class="btn btn-warning" onclick="pauseGame()" id="pauseGameBtn">Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ</button>
                            <button class="btn btn-danger" onclick="endGame()" id="endGameBtn">Í≤åÏûÑ Ï¢ÖÎ£å</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üìä ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥</h3>
                    <div id="myPlayerInfo" class="info-grid"></div>
                </div>
                
                <div class="form-section">
                    <h3>üìà Ï£ºÏãù Ï¢ÖÎ™© Î™©Î°ù</h3>
                    <div id="stocksList" class="stocks-grid"></div>
                </div>
                
                <div class="form-section">
                    <h3>üë• Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Îì§</h3>
                    <div id="otherPlayersList" class="players-grid"></div>
                </div>
                
                <!-- Ï£ºÏãù Í±∞Îûò -->
                <div class="form-section trade-section">
                    <h3>üí∞ Ï£ºÏãù Í±∞Îûò</h3>
                    <div class="trade-form">
                        <div class="form-group">
                            <label>Ï¢ÖÎ™© ÏΩîÎìú</label>
                            <input type="text" id="tradeStockCode" placeholder="Ï¢ÖÎ™© ÏΩîÎìú">
                        </div>
                        <div class="form-group">
                            <label>Í±∞Îûò Ïú†Ìòï</label>
                            <select id="tradeType">
                                <option value="BUY">Îß§Ïàò</option>
                                <option value="SELL">Îß§ÎèÑ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÏàòÎüâ</label>
                            <input type="number" id="tradeQuantity" placeholder="ÏàòÎüâ" min="1">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn" onclick="executeTrade()" id="executeTradeBtn">Í±∞Îûò Ïã§Ìñâ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = localStorage.getItem('token');
        let currentUser = null;
        let selectedGame = null;
        let currentPlayer = null;

        // Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            updateUserStatus();
            if (currentToken) {
                verify();
            }
        };

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÌÉ≠ Ïª®ÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º Ïª®ÌÖêÏ∏† ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Í≤åÏûÑ ÌÉ≠ÏúºÎ°ú Ï†ÑÌôòÏãú ÎÇ¥ Í≤åÏûÑ Î™©Î°ù ÏûêÎèô Î°úÎìú
            if (tabName === 'game' && currentToken) {
                loadMyGames();
            }
        }

        // ÏÇ¨Ïö©Ïûê ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateUserStatus() {
            document.getElementById('loginStatus').textContent = currentToken && currentUser ? 'Î°úÍ∑∏Ïù∏Îê®' : 'Î°úÍ∑∏ÏïÑÏõÉ';
            document.getElementById('loginStatus').className = currentToken && currentUser ? 'logged-in' : 'logged-out';
            document.getElementById('userEmail').textContent = currentUser ? currentUser.email : '-';
            document.getElementById('currentPlayerId').textContent = currentPlayer ? currentPlayer.id : '-';
            document.getElementById('selectedGameId').textContent = selectedGame ? selectedGame.id : '-';
            document.getElementById('tokenDisplay').textContent = currentToken ? currentToken.substring(0, 30) + '...' : '-';
            
            // Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌïú Î≤ÑÌäºÎì§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const authButtons = ['createGameBtn', 'joinGameBtn', 'executeTradeBtn'];
            authButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = !currentToken;
                }
            });
        }

        // Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌïú ÏûëÏóÖ Ï†Ñ Ï≤¥ÌÅ¨
        function checkAuth() {
            if (!currentToken) {
                showError('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return false;
            }
            return true;
        }

        // ÏàòÎèô ÌÜ†ÌÅ∞ ÏÑ§Ï†ï
        function setManualToken() {
            const token = document.getElementById('manualToken').value.trim();
            if (!token) {
                showError('ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            currentToken = token;
            localStorage.setItem('token', token);
            document.getElementById('manualToken').value = '';
            verify();
        }

        // Ïù∏Ï¶ù Ìï®ÏàòÎì§
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const nickname = document.getElementById('registerNickname').value;
            
            if (!email || !password || !nickname) {
                showError('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, nickname })
                });

                const data = await response.json();
                showResponse('ÌöåÏõêÍ∞ÄÏûÖ', data);
                
                if (data.success && data.data) {
                    currentToken = data.data.token;
                    currentUser = data.data.user;
                    localStorage.setItem('token', currentToken);
                    updateUserStatus();
                    showSuccess('ÌöåÏõêÍ∞ÄÏûÖ Î∞è ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
                    
                    // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerNickname').value = '';
                }
            } catch (error) {
                showError('ÌöåÏõêÍ∞ÄÏûÖ ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                showResponse('Î°úÍ∑∏Ïù∏', data);
                
                if (data.success && data.data) {
                    currentToken = data.data.token;
                    currentUser = data.data.user;
                    localStorage.setItem('token', currentToken);
                    updateUserStatus();
                    showSuccess('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
                    
                    // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (error) {
                showError('Î°úÍ∑∏Ïù∏ ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        async function verify() {
            if (!currentToken) return;

            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    currentUser = data.data.user;
                    updateUserStatus();
                    showSuccess('ÌÜ†ÌÅ∞ Ïù∏Ï¶ù ÏÑ±Í≥µ!');
                } else {
                    showError('ÌÜ†ÌÅ∞Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    logout();
                }
            } catch (error) {
                showError('ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå®: ' + error.message);
                logout();
            }
        }

        function logout() {
            currentToken = null;
            currentUser = null;
            selectedGame = null;
            currentPlayer = null;
            localStorage.removeItem('token');
            updateUserStatus();
            
            // Í≤åÏûÑ Í¥ÄÎ†® UI Ï¥àÍ∏∞Ìôî
            document.getElementById('gameDetailSection').classList.add('hidden');
            document.getElementById('myGamesList').innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏ ÌõÑ Í≤åÏûÑ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏÑ∏Ïöî.</div>';
            
            showSuccess('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í≤åÏûÑ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        async function createGame() {
            if (!checkAuth()) return;
            
            const title = document.getElementById('gameTitle').value;
            if (!title) {
                showError('Í≤åÏûÑ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/games`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ title })
                });

                const data = await response.json();
                showResponse('Í≤åÏûÑ ÏÉùÏÑ±', data);
                
                if (data.success) {
                    showSuccess('Í≤åÏûÑÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                    document.getElementById('gameTitle').value = '';
                }
            } catch (error) {
                showError('Í≤åÏûÑ ÏÉùÏÑ± ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        async function joinGame() {
            if (!checkAuth()) return;
            
            const gameId = document.getElementById('joinGameId').value;
            const nickname = document.getElementById('joinNickname').value;
            
            if (!gameId || !nickname) {
                showError('Í≤åÏûÑ IDÏôÄ ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ nickname })
                });

                const data = await response.json();
                showResponse('Í≤åÏûÑ Ï∞∏Í∞Ä', data);
                
                if (data.success) {
                    showSuccess('Í≤åÏûÑÏóê Ï∞∏Í∞ÄÌñàÏäµÎãàÎã§!');
                    document.getElementById('joinGameId').value = '';
                    document.getElementById('joinNickname').value = '';
                }
            } catch (error) {
                showError('Í≤åÏûÑ Ï∞∏Í∞Ä ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        async function loadAllGames() {
            try {
                const response = await fetch(`${API_BASE}/games`);
                const data = await response.json();
                showResponse('Ï†ÑÏ≤¥ Í≤åÏûÑ Î™©Î°ù Ï°∞Ìöå', data);
            } catch (error) {
                showError('Í≤åÏûÑ Î™©Î°ù ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        // ÎÇ¥ Í≤åÏûÑ Î™©Î°ù Î°úÎìú
        async function loadMyGames() {
            if (!checkAuth()) return;

            try {
                // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∞∏Í∞ÄÌïú Í≤åÏûÑ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§Îäî API Ìò∏Ï∂ú
                // Ïã§Ï†ú API ÏóîÎìúÌè¨Ïù∏Ìä∏Ïóê ÎßûÍ≤å ÏàòÏ†ï ÌïÑÏöî
                const response = await fetch(`${API_BASE}/users/games`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    displayMyGames(data.data);
                } else {
                    // ÎåÄÏïà: Ï†ÑÏ≤¥ Í≤åÏûÑ Î™©Î°ùÏóêÏÑú ÎÇ¥Í∞Ä Ï∞∏Í∞ÄÌïú Í≤åÏûÑ ÌïÑÌÑ∞ÎßÅ
                    await loadGamesAlternative();
                }
            } catch (error) {
                showError('ÎÇ¥ Í≤åÏûÑ Î™©Î°ù ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
                // ÎåÄÏïà Î∞©Î≤ï ÏãúÎèÑ
                await loadGamesAlternative();
            }
        }

        // ÎåÄÏïà Î∞©Î≤ï: Ï†ÑÏ≤¥ Í≤åÏûÑÏóêÏÑú ÌïÑÌÑ∞ÎßÅ
        async function loadGamesAlternative() {
            try {
                const response = await fetch(`${API_BASE}/games`);
                const data = await response.json();
                
                if (data.success) {
                    // ÏûÑÏãúÎ°ú Î™®Îì† Í≤åÏûÑÏùÑ ÌëúÏãú (Ïã§Ï†úÎ°úÎäî ÎÇ¥Í∞Ä Ï∞∏Í∞ÄÌïú Í≤åÏûÑÎßå ÌïÑÌÑ∞ÎßÅÌï¥Ïïº Ìï®)
                    displayMyGames(data.data);
                }
            } catch (error) {
                showError('Í≤åÏûÑ Î™©Î°ù ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        function displayMyGames(games) {
            const container = document.getElementById('myGamesList');
            container.innerHTML = '';
            
            if (!games || games.length === 0) {
                container.innerHTML = '<div class="loading">Ï∞∏Í∞ÄÌïú Í≤åÏûÑÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.onclick = () => selectGame(game);
                
                gameCard.innerHTML = `
                    <h4>${game.title}</h4>
                    <p><strong>Í≤åÏûÑ ID:</strong> ${game.id}</p>
                    <p><strong>ÏÉÅÌÉú:</strong> <span class="status ${game.status.toLowerCase()}">${game.status}</span></p>
                    <p><strong>Ï∞∏Í∞ÄÏûê:</strong> ${game.currentPlayers || 0}/${game.maxPlayers || 'N/A'}Î™Ö</p>
                    <p><strong>ÎùºÏö¥Îìú:</strong> ${game.currentRound || 0}/${game.totalRounds || 'N/A'}</p>
                `;
                
                container.appendChild(gameCard);
            });
        }

        // Í≤åÏûÑ ÏÑ†ÌÉù
        async function selectGame(game) {
            selectedGame = game;
            updateUserStatus();
            
            // ÏÑ†ÌÉùÎêú Í≤åÏûÑ Ïπ¥Îìú ÌïòÏù¥ÎùºÏù¥Ìä∏
            document.querySelectorAll('.game-card').forEach(card => card.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú
            await loadGameDetails(game.id);
            
            document.getElementById('gameDetailSection').classList.remove('hidden');
        }

        // Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú
        async function loadGameDetails(gameId) {
            try {
                // Í≤åÏûÑ Ï†ïÎ≥¥
                const gameResponse = await fetch(`${API_BASE}/games/${gameId}`);
                const gameData = await gameResponse.json();
                
                // Ï∞∏Í∞ÄÏûê Î™©Î°ù
                const playersResponse = await fetch(`${API_BASE}/games/${gameId}/players`);
                const playersData = await playersResponse.json();
                
                // Ï¢ÖÎ™© Î™©Î°ù
                const stocksResponse = await fetch(`${API_BASE}/games/${gameId}/stocks`);
                const stocksData = await stocksResponse.json();
                
                if (gameData.success) {
                    displayGameDetails(gameData.data);
                    
                    if (playersData.success) {
                        displayPlayers(playersData.data);
                    }
                    
                    if (stocksData.success) {
                        displayStocks(stocksData.data);
                    }
                }
                
            } catch (error) {
                showError('Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ' + error.message);
            }
        }

        // Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
        function displayGameDetails(game) {
            const container = document.getElementById('gameDetail');
            container.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Í≤åÏûÑ Ï†úÎ™©</strong>
                        ${game.title}
                    </div>
                    <div class="info-item">
                        <strong>Í≤åÏûÑ ID</strong>
                        ${game.id}
                    </div>
                    <div class="info-item">
                        <strong>ÏÉÅÌÉú</strong>
                        <span class="status ${game.status.toLowerCase()}">${game.status}</span>
                    </div>
                    <div class="info-item">
                        <strong>Ï∞∏Í∞ÄÏûê</strong>
                        ${game.currentPlayers || 0}/${game.maxPlayers || 'N/A'}Î™Ö
                    </div>
                    <div class="info-item">
                        <strong>ÌòÑÏû¨ ÎùºÏö¥Îìú</strong>
                        ${game.currentRound || 0}/${game.totalRounds || 'N/A'}
                    </div>
                    <div class="info-item">
                        <strong>Í≤åÏûÑ ÏãúÍ∞Ñ</strong>
                        ${game.gameDuration || 'N/A'}Ï¥à
                    </div>
                    <div class="info-item">
                        <strong>Ìò∏Ïä§Ìä∏</strong>
                        ${game.hostUserId ? (game.hostUserId === (currentUser ? currentUser.id : null) ? 'ÎÇò' : game.hostUserId) : 'N/A'}
                    </div>
                </div>
            `;
            
            // Ìò∏Ïä§Ìä∏ Í∂åÌïú ÌôïÏù∏ Î∞è Ïª®Ìä∏Î°§ ÌëúÏãú
            checkHostPermissions(game);
        }

        // Ìò∏Ïä§Ìä∏ Í∂åÌïú ÌôïÏù∏
        function checkHostPermissions(game) {
    console.log('checkHostPermissions Ìï®Ïàò Ïã§ÌñâÎê®');
    console.log('Í≤åÏûÑ ÏÉÅÌÉú:', game.status);
    
    const hostControls = document.getElementById('hostControls');
    const startBtn = document.getElementById('startGameBtn');
    const pauseBtn = document.getElementById('pauseGameBtn');
    const endBtn = document.getElementById('endGameBtn');
    
    console.log('Î≤ÑÌäº ÏöîÏÜåÎì§:', { startBtn, pauseBtn, endBtn });
    
    const isHost = game.hostUserId === (currentUser ? currentUser.id : null);
    
    if (isHost) {
        hostControls.classList.remove('hidden');
        console.log('Ìò∏Ïä§Ìä∏ Í∂åÌïú ÌôïÏù∏Îê®, Í≤åÏûÑ ÏÉÅÌÉú Ï≤¥ÌÅ¨ ÏãúÏûë');
        
        const gameStatus = game.status.toUpperCase();
        // Í≤åÏûÑ ÏÉÅÌÉúÏóê Îî∞Îùº Î≤ÑÌäº ÌëúÏãú/Ïà®ÍπÄ
        if (gameStatus === 'WAITING') {
            console.log('WAITING ÏÉÅÌÉú Ï≤òÎ¶¨');
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            endBtn.style.display = 'none';
        } else if (game.status === 'PLAYING') {
            console.log('PLAYING ÏÉÅÌÉú Ï≤òÎ¶¨');
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            endBtn.style.display = 'inline-block';
        } else if (game.status === 'PAUSED') {
            console.log('PAUSED ÏÉÅÌÉú Ï≤òÎ¶¨');
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Í≤åÏûÑ Ïû¨Í∞ú';
            pauseBtn.style.display = 'none';
            endBtn.style.display = 'inline-block';
        } else {
            console.log('Í∏∞ÌÉÄ ÏÉÅÌÉú(' + game.status + ') Ï≤òÎ¶¨ - Î™®Îì† Î≤ÑÌäº Ïà®ÍπÄ');
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            endBtn.style.display = 'none';
        }
        
        console.log('ÏµúÏ¢Ö Î≤ÑÌäº display ÏÉÅÌÉú:');
        console.log('startBtn:', startBtn.style.display);
        console.log('pauseBtn:', pauseBtn.style.display);
        console.log('endBtn:', endBtn.style.display);
    } else {
        hostControls.classList.add('hidden');
    }
}

        // Í≤åÏûÑ ÏãúÏûë
        async function startGame() {
            if (!checkAuth() || !selectedGame) {
                showError('Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {

                if (currentPlayer && !currentPlayer.isReady) {
                    const readyResponse = await fetch(`${API_BASE}/games/${selectedGame.id}/ready`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: JSON.stringify({ isReady: true })
                    });

                    if (!readyResponse.ok) {
                        const readyData = await readyResponse.json();
                        showError('Ìò∏Ïä§Ìä∏ Ï§ÄÎπÑ ÏÉÅÌÉú ÏÑ§Ï†ï Ïã§Ìå®: ' + (readyData.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                        return;
                    }
                }

                const response = await fetch(`${API_BASE}/games/${selectedGame.id}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                showResponse('Í≤åÏûÑ ÏãúÏûë', data);
                
                if (data.success) {
                    showSuccess('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! Í≤åÏûÑ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
                    setTimeout(() => {
                        window.open(`game-play.html?gameId=${selectedGame.id}`, '_blank');
                    }, 2000);
                    await loadGameDetails(selectedGame.id);
                } else {
                    showError('Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                showError('Í≤åÏûÑ ÏãúÏûë ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        // Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ
        async function pauseGame() {
            if (!checkAuth() || !selectedGame) {
                showError('Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/games/${selectedGame.id}/pause`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                showResponse('Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ', data);
                
                if (data.success) {
                    showSuccess('Í≤åÏûÑÏù¥ ÏùºÏãúÏ†ïÏßÄÎêòÏóàÏäµÎãàÎã§.');
                    await loadGameDetails(selectedGame.id);
                } else {
                    showError('Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                showError('Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        async function endGame() {
            if (!checkAuth() || !selectedGame) {
                showError('Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!confirm('Ï†ïÎßêÎ°ú Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/games/${selectedGame.id}/end`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                showResponse('Í≤åÏûÑ Ï¢ÖÎ£å', data);
                
                if (data.success) {
                    showSuccess('Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
                    await loadGameDetails(selectedGame.id);
                } else {
                    showError('Í≤åÏûÑ Ï¢ÖÎ£å Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                showError('Í≤åÏûÑ Ï¢ÖÎ£å ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        // ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ ÌëúÏãú
        function displayPlayers(players) {
            if (!players || players.length === 0) {
                document.getElementById('myPlayerInfo').innerHTML = '<div class="loading">ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                document.getElementById('otherPlayersList').innerHTML = '<div class="loading">Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏùò ÌîåÎ†àÏù¥Ïñ¥ Ï∞æÍ∏∞
            const myPlayer = players.find(p => p.userId === (currentUser ? currentUser.id : null));
            currentPlayer = myPlayer;
            updateUserStatus();

            // ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ ÌëúÏãú
            if (myPlayer) {
                const myPlayerContainer = document.getElementById('myPlayerInfo');
                myPlayerContainer.innerHTML = `
                    <div class="info-item">
                        <strong>ÎãâÎÑ§ÏûÑ</strong>
                        ${myPlayer.nickname}
                    </div>
                    <div class="info-item">
                        <strong>ÌîåÎ†àÏù¥Ïñ¥ ID</strong>
                        ${myPlayer.id}
                    </div>
                    <div class="info-item">
                        <strong>ÌòÑÏû¨ ÌòÑÍ∏à</strong>
                        ${(myPlayer.currentCash || 0).toLocaleString()}Ïõê
                    </div>
                    <div class="info-item">
                        <strong>Ï¥ù ÏûêÏÇ∞ Í∞ÄÏπò</strong>
                        ${(myPlayer.totalAssetValue || 0).toLocaleString()}Ïõê
                    </div>
                    <div class="info-item">
                        <strong>ÏÜêÏùµ</strong>
                        <span class="price-change ${(myPlayer.profitLoss || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(myPlayer.profitLoss || 0).toLocaleString()}Ïõê
                        </span>
                    </div>
                    <div class="info-item">
                        <strong>ÏàòÏùµÎ•†</strong>
                        <span class="price-change ${(myPlayer.profitRate || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(myPlayer.profitRate || 0).toFixed(2)}%
                        </span>
                    </div>
                    <div class="info-item">
                        <strong>ÌòÑÏû¨ ÏàúÏúÑ</strong>
                        ${myPlayer.ranking || '-'}ÏúÑ
                    </div>
                `;
            } else {
                document.getElementById('myPlayerInfo').innerHTML = '<div class="loading">ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }

            // Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Îì§ ÌëúÏãú
            const otherPlayers = players.filter(p => p.id !== (myPlayer ? myPlayer.id : null));
            const otherPlayersContainer = document.getElementById('otherPlayersList');
            
            if (otherPlayers.length === 0) {
                otherPlayersContainer.innerHTML = '<div class="loading">Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            otherPlayersContainer.innerHTML = '';
            otherPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.innerHTML = `
                    <h4>${player.nickname}</h4>
                    <p><strong>ÌîåÎ†àÏù¥Ïñ¥ ID:</strong> ${player.id}</p>
                    <p><strong>ÌòÑÏû¨ ÌòÑÍ∏à:</strong> ${(player.currentCash || 0).toLocaleString()}Ïõê</p>
                    <p><strong>Ï¥ù ÏûêÏÇ∞:</strong> ${(player.totalAssetValue || 0).toLocaleString()}Ïõê</p>
                    <p><strong>ÏàòÏùµÎ•†:</strong> 
                        <span class="price-change ${(player.profitRate || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(player.profitRate || 0).toFixed(2)}%
                        </span>
                    </p>
                    <p><strong>ÏàúÏúÑ:</strong> ${player.ranking || '-'}ÏúÑ</p>
                `;
                otherPlayersContainer.appendChild(playerCard);
            });
        }

        // Ï£ºÏãù Ï¢ÖÎ™© ÌëúÏãú
        function displayStocks(stocks) {
            const container = document.getElementById('stocksList');
            
            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<div class="loading">Ï¢ÖÎ™© Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            container.innerHTML = '';
            stocks.forEach(stock => {
                const currentPrice = Number(stock.currentPrice) || 0;
                const initialPrice = Number(stock.initialPrice) || 1;
                const changePercent = ((currentPrice - initialPrice) / initialPrice * 100).toFixed(2);
                
                const stockCard = document.createElement('div');
                stockCard.className = 'stock-card';
                stockCard.innerHTML = `
                    <h4>${stock.stockTemplate?.name || stock.stockCode}</h4>
                    <p><strong>Ï¢ÖÎ™© ÏΩîÎìú:</strong> ${stock.stockCode}</p>
                    <p><strong>ID:</strong> ${stock.id}</p>
                    <p><strong>ÏÑπÌÑ∞:</strong> ${stock.stockTemplate?.sector || 'N/A'}</p>
                    <p><strong>ÌòÑÏû¨Í∞Ä:</strong> ${currentPrice.toLocaleString()}Ïõê</p>
                    <p><strong>Ï¥àÍ∏∞Í∞Ä:</strong> ${initialPrice.toLocaleString()}Ïõê</p>
                    <p><strong>Î≥ÄÎèôÎ•†:</strong> 
                        <span class="price-change ${changePercent >= 0 ? 'positive' : 'negative'}">
                            ${changePercent}%
                        </span>
                    </p>
                    <p><strong>Î≥ÄÎèôÏÑ±:</strong> ${((stock.volatility || 0) * 100).toFixed(1)}%</p>
                    <button class="btn btn-success" onclick="setTradeStock('${stock.stockCode}')">Í±∞ÎûòÌïòÍ∏∞</button>
                `;
                container.appendChild(stockCard);
            });
        }

        // Í±∞ÎûòÌï† Ï¢ÖÎ™© ÏÑ§Ï†ï
        function setTradeStock(stockCode) {
            document.getElementById('tradeStockCode').value = stockCode;
            document.getElementById('tradeStockCode').focus();
        }

        // Ï£ºÏãù Í±∞Îûò Ïã§Ìñâ
        async function executeTrade() {
            if (!checkAuth() || !selectedGame || !currentPlayer) {
                showError('Î°úÍ∑∏Ïù∏ÌïòÍ≥† Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const stockCode = document.getElementById('tradeStockCode').value;
            const type = document.getElementById('tradeType').value;
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            
            if (!stockCode || !quantity) {
                showError('Ï¢ÖÎ™© ÏΩîÎìúÏôÄ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/games/${selectedGame.id}/trades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ 
                        playerId: currentPlayer.id, 
                        stockCode, 
                        type, 
                        quantity 
                    })
                });

                const data = await response.json();
                showResponse('Í±∞Îûò Ïã§Ìñâ', data);
                
                if (data.success) {
                    showSuccess(`${type === 'BUY' ? 'Îß§Ïàò' : 'Îß§ÎèÑ'} Í±∞ÎûòÍ∞Ä Ï≤¥Í≤∞ÎêòÏóàÏäµÎãàÎã§!`);
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('tradeStockCode').value = '';
                    document.getElementById('tradeQuantity').value = '';
                    
                    // Í≤åÏûÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®
                    await loadGameDetails(selectedGame.id);
                } else {
                    showError('Í±∞Îûò Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                showError('Í±∞Îûò ÏöîÏ≤≠ Ïã§Ìå®: ' + error.message);
            }
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function showResponse(action, data) {
            const responseDiv = document.getElementById('apiResponse');
            responseDiv.textContent = `[${new Date().toLocaleTimeString()}] ${action}:\n${JSON.stringify(data, null, 2)}`;
        }

        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïóê Î©îÏãúÏßÄ ÌëúÏãú
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(errorDiv, activeTab.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïóê Î©îÏãúÏßÄ ÌëúÏãú
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(successDiv, activeTab.firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showWarning(message) {
            const existingWarning = document.querySelector('.warning');
            if (existingWarning) existingWarning.remove();
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning';
            warningDiv.textContent = message;
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïóê Î©îÏãúÏßÄ ÌëúÏãú
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(warningDiv, activeTab.firstChild);
            
            setTimeout(() => warningDiv.remove(), 4000);
        }

        // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        showTab('auth');
                        break;
                    case '2':
                        e.preventDefault();
                        showTab('game');
                        break;
                    case 'r':
                        e.preventDefault();
                        if (selectedGame) {
                            loadGameDetails(selectedGame.id);
                        }
                        break;
                    case 'm':
                        e.preventDefault();
                        if (currentToken) {
                            loadMyGames();
                        }
                        break;
                }
            }
        });

        // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (ÏÑ†ÌÉùÏ†Å)
        function startAutoRefresh() {
            setInterval(() => {
                if (selectedGame && currentToken && document.getElementById('game-tab').classList.contains('active')) {
                    loadGameDetails(selectedGame.id);
                }
            }, 15000); // 15Ï¥àÎßàÎã§ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
        }

        // ÌïÑÏöîÏãú ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
        // startAutoRefresh();
    </script>
</body>
</html>